<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>ATTAMATION - Soil Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<style>
/* (Deklarasi variabel :root dan style universal lainnya tidak saya ubah) */
:root{--bg:#070617;--card:#0f1220;--accent:#00f1ff;--accent2:#9b4dff;--muted:#9aa3b2;--success:#00ff88;--warning:#ffaa00;--danger:#ff6b6b;--glow:0 8px 30px rgba(155,77,255,0.12)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;font-family:'Inter',Arial,sans-serif;background:radial-gradient(1200px 600px at 10% 10%,rgba(155,77,255,0.06),transparent),linear-gradient(180deg,#060613 0%,#0b0f1a 100%);color:#e6eef8;overflow-x:hidden}

/* FONT ASLI DI SINI (Orbitron) */
header h1{font-family:'Orbitron',sans-serif;letter-spacing:2px;color:var(--accent2);margin:0;font-size:28px}
.big-value{font-family:'Orbitron',sans-serif;color:var(--accent);font-size:84px;text-shadow:0 6px 30px rgba(0,241,255,0.08);line-height:1}

.wrap{max-width:1200px;margin:0 auto;padding:18px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:12px}
header .right{text-align:right;color:var(--muted);font-size:14px}
.tabs{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap}
.tab{padding:10px 20px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,0.02);color:var(--muted);border:1px solid rgba(255,255,255,0.03);font-weight:600;transition:all 0.3s}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021}
.tab-content{display:none}
.tab-content.active{display:block}
.connection-status{background:rgba(255,255,255,0.02);padding:8px 14px;border-radius:8px;margin-bottom:14px;display:flex;align-items:center;gap:8px;font-size:13px}
.status-dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}
.status-dot.online{background:var(--success)}
.grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.007));border-radius:14px;padding:20px;box-shadow:var(--glow);border:1px solid rgba(255,255,255,0.03)}
.big-stat{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px}
.big-stat-header{width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.big-stat-title{font-size:16px;color:var(--muted)}
.subtitle{color:var(--muted);margin-top:8px}
.threshold-info{font-size:12px;color:var(--warning);margin-top:8px;padding:6px 12px;background:rgba(255,170,0,0.1);border-radius:6px}
.small-row{display:flex;gap:12px;margin-top:18px;justify-content:center;flex-wrap:wrap}
.stat-mini{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;min-width:100px;text-align:center}
.stat-mini h4{margin:0;font-size:14px;color:var(--muted)}
.stat-mini p{margin:6px 0 0 0;font-weight:700;font-size:15px}
.control-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:12px}
.control-title{font-weight:700;color:var(--muted)}
.mode-toggle{display:flex;gap:8px;align-items:center}
.mode-label{font-size:12px;color:var(--muted)}
.mode-select,.date-input{background:rgba(0,0,0,0.3);color:var(--accent);border-radius:8px;padding:6px 10px;border:1px solid rgba(255,255,255,0.1);font-size:13px}
.device-card{background:linear-gradient(180deg,#0b0f1a,#0b0f1a);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);margin-bottom:12px}
.device-row{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.device-name{font-weight:600}
.device-desc{font-size:12px;color:var(--muted)}
.pump-state{color:var(--danger);font-weight:700;font-size:18px}
.pump-state.on{color:var(--success)}
.controls{margin-top:12px;display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}
.control-group{display:flex;flex-direction:column;gap:4px}
.control-label{font-size:11px;color:var(--muted)}
.control-input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent);width:70px;font-size:14px;text-align:center}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021;padding:8px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;font-size:13px;white-space:nowrap}
.btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.1)}
.btn.sm{padding:6px 10px;font-size:11px}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.manual-controls{display:none;margin-left:auto;gap:8px}
.manual-controls.show{display:flex}
.info-text{font-size:11px;color:var(--muted);text-align:center;padding-top:8px;line-height:1.6}

/* Date Navigation */
.date-nav{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:16px;
  flex-wrap:wrap;
  padding:12px;
  background:rgba(255,255,255,0.02);
  border-radius:10px
}
.date-nav-btn{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--accent);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:18px}
.date-nav-btn:hover{background:rgba(255,255,255,0.1)}
.date-display{flex:1;text-align:center;font-weight:600;color:var(--accent);font-size:14px}
.time-slider{width:100%;margin:10px 0}
.time-range{display:flex;justify-content:space-between;font-size:11px;color:var(--muted)}

/* History (Tidak ada perubahan) */
.history-container{max-height:500px;overflow-y:auto}
.history-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:8px;gap:10px}
.history-icon{font-size:20px;min-width:30px}
.history-main{flex:1}
.history-event{font-weight:600;font-size:14px}
.history-event.on{color:var(--success)}
.history-event.off{color:var(--danger)}
.history-event.auto{color:var(--accent)}
.history-event.manual{color:var(--accent2)}
.history-details{font-size:11px;color:var(--muted);margin-top:2px}
.history-badge{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600}
.history-badge.auto{background:rgba(0,241,255,0.15);color:var(--accent)}
.history-badge.manual{background:rgba(155,77,255,0.15);color:var(--accent2)}
.history-badge.system{background:rgba(255,170,0,0.15);color:var(--warning)}
.history-right{text-align:right}
.history-time{font-size:11px;color:var(--muted)}
.history-count{font-size:12px;color:var(--muted);margin-bottom:10px}
.no-data{text-align:center;color:var(--muted);padding:40px}

/* Charts (Tidak ada perubahan) */
.chart-container{background:rgba(255,255,255,0.02);border-radius:12px;padding:16px;margin-bottom:16px}
.chart-title{font-size:14px;color:var(--muted);margin-bottom:12px;font-weight:600}
.chart-wrapper{height:200px;position:relative}

/* Storage info (Tidak ada perubahan) */
.storage-info{font-size:11px;color:var(--muted);text-align:center;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;margin-top:12px}

/* Responsive Styles */
@media(max-width:900px){
  /* Perubahan untuk tablet atau perangkat sedang */
  .grid{grid-template-columns:1fr}
  .big-value{font-size:64px}
  header h1{font-size:22px}
}

@media(max-width:600px){
  /* Perbaikan KHUSUS untuk Mobile (Mode Potret) */
  .wrap{padding:12px}
  
  /* 1. Perbaikan Tabs (History dan Trends harus berdampingan) */
  .tabs{
    flex-wrap: nowrap; /* Pastikan tab tetap dalam satu baris */
    overflow-x: auto;  /* Jika terlalu banyak, bisa digeser */
    padding-bottom: 5px; /* Tambahkan sedikit ruang */
  }
  .tab{
    flex-shrink: 0; /* Hindari pengecilan paksa */
    padding: 8px 16px; /* Lebih kompak */
  }

  /* 2. Stat Besar - Ukuran lebih kecil */
  .big-value{font-size:48px}
  .big-stat{min-height:auto;padding:16px}
  .card{padding:14px}
  
  /* 3. Mini Stats - Horizontal dan rata */
  .small-row{
    flex-direction: row; 
    justify-content: space-around;
    gap: 8px;
    width: 100%;
  }
  .stat-mini{
    width: auto; 
    min-width: 90px;
    padding: 10px 8px;
  }
  .stat-mini h4{font-size:12px}
  .stat-mini p{font-size:14px}
  
  /* 4. Kontrol Perangkat - Tata letak tombol lebih efisien */
  .controls{
    flex-direction: row; 
    align-items: flex-end; 
    justify-content: space-between;
    flex-wrap: wrap;
  }
  .control-group{
    width: 30%; 
    max-width: 80px;
  }
  .control-input{
    width: 100%; 
  }
  .btn{
    width: auto; 
    margin-left: auto; 
  }
  .manual-controls{
    margin-top: 10px;
    margin-left: 0; 
    width: 100%; 
    flex-direction: row; 
    justify-content: space-between;
  }
  .manual-controls button{
    flex: 1; 
    margin-right: 5px; /* Jarak antar tombol */
  }
  .manual-controls button:last-child{
    margin-right: 0;
  }

  /* 5. Perbaikan Navigasi Tanggal (Date Navigation) */
  .date-nav{
    flex-direction: row; /* Kembali ke baris */
    align-items: center;
    justify-content: space-between; /* Untuk meratakan elemen */
    flex-wrap: nowrap; /* Pastikan semua elemen di satu baris */
    padding: 8px;
  }
  .date-nav-btn, .date-input, .date-nav #histToday, .date-nav #trendToday {
    width: auto; /* Hapus paksaan lebar 100% */
    flex-shrink: 0; /* Cegah pengecilan */
  }
  
  /* Atur input tanggal agar mengambil sisa ruang */
  .date-input{
    flex-grow: 1; /* Agar input tanggal melebar */
    margin: 0 5px; /* Jarak kecil dari tombol kiri/kanan */
    text-align: center;
  }
  
  /* Atur agar tombol Prev dan Next mengapit input tanggal */
  .date-nav #histPrevDay, .date-nav #trendPrevDay { order: 1; }
  .date-nav input[type="date"] { order: 2; }
  .date-nav #histNextDay, .date-nav #trendNextDay { order: 3; }
  .date-nav #histToday, .date-nav #trendToday { 
    order: 4; /* Tombol Today berada di sisi paling kanan */
    margin-left: 5px;
  }
}
</style>
</head>
<body>
<div class="wrap">
<header>
  <h1>ATTAMATION</h1>
  <div class="right">
    <div id="clock">--:--:--</div>
    <div id="date">--</div>
  </div>
</header>

<div class="connection-status">
  <div class="status-dot" id="statusDot"></div>
  <span id="statusText">Connecting to MQTT...</span>
</div>

<div class="tabs">
  <div class="tab active" data-tab="dashboard">üìä Dashboard</div>
  <div class="tab" data-tab="history">üìú History</div>
  <div class="tab" data-tab="trends">üìà Trends</div>
</div>

<div class="tab-content active" id="tab-dashboard">
<div class="grid">
  <div class="card big-stat">
    <div class="big-stat-header">
      <div class="big-stat-title">SOIL MOISTURE</div>
    </div>
    <div class="big-value" id="soilPercent">--</div>
    <div class="subtitle">Current Level</div>
    <div class="threshold-info" id="thresholdInfo">Pump ON &lt; 35% | OFF ‚â• 40%</div>
    <div class="small-row">
      <div class="stat-mini"><h4>Temp</h4><p id="tempVal">--¬∞C</p></div>
      <div class="stat-mini"><h4>Humidity</h4><p id="humVal">--%</p></div>
      <div class="stat-mini"><h4>Raw</h4><p id="soilRaw">--</p></div>
    </div>
  </div>

  <div class="card">
    <div class="control-header">
      <div class="control-title">DEVICE CONTROL</div>
      <div class="mode-toggle">
        <span class="mode-label">Mode</span>
        <select id="modeSelect" class="mode-select">
          <option value="AUTO">AUTO</option>
          <option value="MANUAL">MANUAL</option>
        </select>
      </div>
    </div>

    <div class="device-card">
      <div class="device-row">
        <div>
          <div class="device-name">üíß Water Pump</div>
          <div class="device-desc">Irrigation System</div>
        </div>
        <div style="text-align:right">
          <div class="pump-state" id="pumpState">OFF</div>
          <div style="font-size:11px;color:var(--muted)">Status</div>
        </div>
      </div>

      <div class="controls">
        <div class="control-group">
          <div class="control-label">Setpoint (%)</div>
          <input id="setpoint" type="number" min="0" max="100" value="40" class="control-input"/>
        </div>
        <div class="control-group">
          <div class="control-label">Hysteresis</div>
          <input id="hysteresis" type="number" min="1" max="20" value="5" class="control-input"/>
        </div>
        <button class="btn" id="setBtn">SET</button>
        <div id="manualControls" class="manual-controls">
          <button class="btn" id="pumpOn">ON</button>
          <button class="btn secondary" id="pumpOff">OFF</button>
        </div>
      </div>
    </div>

    <div class="info-text">
      <div><b>Hysteresis</b> prevents pump flickering</div>
      <div>Pump ON when soil &lt; (setpoint - hysteresis)</div>
    </div>
  </div>
</div>
</div>

<div class="tab-content" id="tab-history">
<div class="card">
  <div class="control-header">
    <div class="control-title">üìú SYSTEM HISTORY</div>
    <button class="btn secondary sm" id="clearHistory">Clear All</button>
  </div>
  
  <div class="date-nav">
    <button class="date-nav-btn" id="histPrevDay">‚óÄ</button>
    <input type="date" id="historyDate" class="date-input">
    <button class="date-nav-btn" id="histNextDay">‚ñ∂</button>
    <button class="btn sm" id="histToday">Today</button>
  </div>
  
  <select id="historyFilter" class="mode-select" style="width:100%;margin-bottom:12px">
    <option value="all">All Events</option>
    <option value="pump">Pump Only</option>
    <option value="mode">Mode Only</option>
    <option value="auto">Auto Trigger</option>
    <option value="manual">Manual Trigger</option>
  </select>
  
  <div class="history-count" id="historyCount">0 events</div>
  <div class="history-container" id="historyContainer">
    <div class="no-data">No history yet</div>
  </div>
  
  <div class="storage-info" id="historyStorageInfo">Storage: 0 events (0 days)</div>
</div>
</div>

<div class="tab-content" id="tab-trends">
<div class="card">
  <div class="control-header">
    <div class="control-title">üìà SENSOR TRENDS</div>
    <button class="btn secondary sm" id="clearTrends">Clear All</button>
  </div>
  
  <div class="date-nav">
    <button class="date-nav-btn" id="trendPrevDay">‚óÄ</button>
    <input type="date" id="trendDate" class="date-input">
    <button class="date-nav-btn" id="trendNextDay">‚ñ∂</button>
    <button class="btn sm" id="trendToday">Today</button>
  </div>
  
  <div class="chart-container">
    <div class="chart-title">üå± Soil Moisture (%)</div>
    <div class="chart-wrapper"><canvas id="soilChart"></canvas></div>
  </div>
  
  <div class="chart-container">
    <div class="chart-title">üå°Ô∏è Temperature (¬∞C)</div>
    <div class="chart-wrapper"><canvas id="tempChart"></canvas></div>
  </div>
  
  <div class="chart-container">
    <div class="chart-title">üíß Humidity (%)</div>
    <div class="chart-wrapper"><canvas id="humChart"></canvas></div>
  </div>
  
  <div class="storage-info" id="trendStorageInfo">Storage: 0 data points (0 days)</div>
</div>
</div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
// (Kode JavaScript tetap sama)
// ============ CONSTANTS ============
const MAX_DAYS = 14; // 2 weeks retention
const TREND_INTERVAL = 1000; // Save trend every 1 second
const DATA_VERSION = 2;

// ============ STATE ============
let userEditingSetpoint = false;
let userEditingHysteresis = false;
let currentMode = "AUTO";
let lastTrendSave = 0;

// Data storage with date keys
let eventHistory = {}; // { "2024-01-15": [{...}, {...}], ... }
let trendData = {};    // { "2024-01-15": { soil:[], temp:[], hum:[], time:[] }, ... }

// Current view dates
let historyViewDate = new Date();
let trendViewDate = new Date();

// ============ UTILITY FUNCTIONS ============
function formatDate(d) {
  return d.toISOString().split('T')[0]; // "YYYY-MM-DD"
}

function formatTime(d) {
  return d.toTimeString().split(' ')[0]; // "HH:MM:SS"
}

function formatDateTime(d) {
  return d.toLocaleString();
}

function pad(n) { return n < 10 ? '0' + n : n; }

function getDateKey(date = new Date()) {
  return formatDate(date);
}

function parseDate(dateStr) {
  return new Date(dateStr + 'T00:00:00');
}

// ============ DATA MANAGEMENT ============
function loadData() {
  try {
    const savedEvents = localStorage.getItem('eventHistory_v' + DATA_VERSION);
    const savedTrends = localStorage.getItem('trendData_v' + DATA_VERSION);
    
    if (savedEvents) eventHistory = JSON.parse(savedEvents);
    if (savedTrends) trendData = JSON.parse(savedTrends);
    
    // Clean old data (older than MAX_DAYS)
    cleanOldData();
  } catch(e) {
    console.error("Load data error:", e);
    eventHistory = {};
    trendData = {};
  }
}

function saveData() {
  try {
    localStorage.setItem('eventHistory_v' + DATA_VERSION, JSON.stringify(eventHistory));
    localStorage.setItem('trendData_v' + DATA_VERSION, JSON.stringify(trendData));
  } catch(e) {
    console.error("Save data error:", e);
    // If storage full, remove oldest day
    removeOldestDay();
    saveData();
  }
}

function cleanOldData() {
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - MAX_DAYS);
  const cutoffKey = formatDate(cutoffDate);
  
  // Clean events
  Object.keys(eventHistory).forEach(key => {
    if (key < cutoffKey) delete eventHistory[key];
  });
  
  // Clean trends
  Object.keys(trendData).forEach(key => {
    if (key < cutoffKey) delete trendData[key];
  });
  
  saveData();
}

function removeOldestDay() {
  const eventKeys = Object.keys(eventHistory).sort();
  const trendKeys = Object.keys(trendData).sort();
  
  if (eventKeys.length > 0) delete eventHistory[eventKeys[0]];
  if (trendKeys.length > 0) delete trendData[trendKeys[0]];
}

function getStorageStats() {
  const eventDays = Object.keys(eventHistory).length;
  const trendDays = Object.keys(trendData).length;
  
  let totalEvents = 0;
  Object.values(eventHistory).forEach(arr => totalEvents += arr.length);
  
  let totalTrends = 0;
  Object.values(trendData).forEach(d => totalTrends += (d.time?.length || 0));
  
  return { eventDays, trendDays, totalEvents, totalTrends };
}

// ============ CLOCK ============
function updateClock() {
  const d = new Date();
  document.getElementById('clock').innerText = pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
  document.getElementById('date').innerText = d.toLocaleDateString();
}
setInterval(updateClock, 1000);
updateClock();

// ============ TABS ============
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    
    if (tab.dataset.tab === 'history') renderHistory();
    if (tab.dataset.tab === 'trends') updateCharts();
  });
});

// ============ DATE NAVIGATION ============
// History date navigation
document.getElementById('historyDate').addEventListener('change', function() {
  historyViewDate = parseDate(this.value);
  renderHistory();
});

document.getElementById('histPrevDay').addEventListener('click', () => {
  historyViewDate.setDate(historyViewDate.getDate() - 1);
  document.getElementById('historyDate').value = formatDate(historyViewDate);
  renderHistory();
});

document.getElementById('histNextDay').addEventListener('click', () => {
  historyViewDate.setDate(historyViewDate.getDate() + 1);
  document.getElementById('historyDate').value = formatDate(historyViewDate);
  renderHistory();
});

document.getElementById('histToday').addEventListener('click', () => {
  historyViewDate = new Date();
  document.getElementById('historyDate').value = formatDate(historyViewDate);
  renderHistory();
});

// Trend date navigation
document.getElementById('trendDate').addEventListener('change', function() {
  trendViewDate = parseDate(this.value);
  updateCharts();
});

document.getElementById('trendPrevDay').addEventListener('click', () => {
  trendViewDate.setDate(trendViewDate.getDate() - 1);
  document.getElementById('trendDate').value = formatDate(trendViewDate);
  updateCharts();
});

document.getElementById('trendNextDay').addEventListener('click', () => {
  trendViewDate.setDate(trendViewDate.getDate() + 1);
  document.getElementById('trendDate').value = formatDate(trendViewDate);
  updateCharts();
});

document.getElementById('trendToday').addEventListener('click', () => {
  trendViewDate = new Date();
  document.getElementById('trendDate').value = formatDate(trendViewDate);
  updateCharts();
});

// Initialize date inputs
document.getElementById('historyDate').value = formatDate(new Date());
document.getElementById('trendDate').value = formatDate(new Date());

// ============ CHARTS ============
const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  scales: {
    x: {
      type: 'category',
      display: true,
      grid: { color: 'rgba(255,255,255,0.03)' },
      ticks: { color: '#9aa3b2', maxTicksLimit: 8, maxRotation: 0 }
    },
    y: {
      display: true,
      grid: { color: 'rgba(255,255,255,0.03)' },
      ticks: { color: '#9aa3b2' }
    }
  },
  plugins: { legend: { display: false } },
  elements: { point: { radius: 1 }, line: { tension: 0.3, borderWidth: 2 } },
  interaction: { intersect: false, mode: 'index' }
};

const soilChart = new Chart(document.getElementById('soilChart'), {
  type: 'line',
  data: { labels: [], datasets: [{ data: [], borderColor: '#00f1ff', backgroundColor: 'rgba(0,241,255,0.1)', fill: true }] },
  options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, min: 0, max: 100 } } }
});

const tempChart = new Chart(document.getElementById('tempChart'), {
  type: 'line',
  data: { labels: [], datasets: [{ data: [], borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.1)', fill: true }] },
  options: chartOptions
});

const humChart = new Chart(document.getElementById('humChart'), {
  type: 'line',
  data: { labels: [], datasets: [{ data: [], borderColor: '#9b4dff', backgroundColor: 'rgba(155,77,255,0.1)', fill: true }] },
  options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, min: 0, max: 100 } } }
});

function updateCharts() {
  const dateKey = formatDate(trendViewDate);
  const dayData = trendData[dateKey] || { soil: [], temp: [], hum: [], time: [] };
  
  soilChart.data.labels = dayData.time || [];
  soilChart.data.datasets[0].data = dayData.soil || [];
  soilChart.update('none');
  
  tempChart.data.labels = dayData.time || [];
  tempChart.data.datasets[0].data = dayData.temp || [];
  tempChart.update('none');
  
  humChart.data.labels = dayData.time || [];
  humChart.data.datasets[0].data = dayData.hum || [];
  humChart.update('none');
  
  // Update storage info
  const stats = getStorageStats();
  document.getElementById('trendStorageInfo').innerText = 
    `Storage: ${stats.totalTrends} data points across ${stats.trendDays} days (max ${MAX_DAYS} days)`;
}

function addTrendPoint(soil, temp, hum) {
  const now = Date.now();
  
  // Only save every TREND_INTERVAL ms
  if (now - lastTrendSave < TREND_INTERVAL) return;
  lastTrendSave = now;
  
  const dateKey = getDateKey();
  const timeLabel = formatTime(new Date());
  
  if (!trendData[dateKey]) {
    trendData[dateKey] = { soil: [], temp: [], hum: [], time: [] };
  }
  
  const dayData = trendData[dateKey];
  dayData.time.push(timeLabel);
  dayData.soil.push(soil);
  dayData.temp.push(temp > -90 ? temp : null);
  dayData.hum.push(hum >= 0 ? hum : null);
  
  // Limit per day (every 1s = 86400 points/day max, keep last 3600 = 1 hour detail)
  if (dayData.time.length > 3600) {
    dayData.time.shift();
    dayData.soil.shift();
    dayData.temp.shift();
    dayData.hum.shift();
  }
  
  saveData();
  
  // Update chart if viewing today
  if (formatDate(trendViewDate) === dateKey) {
    updateCharts();
  }
}

// ============ HISTORY ============
function getHistoryIcon(type, action) {
  if (type === 'pump') return action === 'ON' ? 'üíß' : 'üö´';
  if (type === 'mode') return action === 'AUTO' ? 'ü§ñ' : 'üñêÔ∏è';
  return 'üìù';
}

function getHistoryText(type, action, trigger) {
  if (type === 'pump') {
    const triggerText = trigger === 'auto' ? '(Auto)' : trigger === 'manual' ? '(Manual)' : '';
    return action === 'ON' ? `Pump ON ${triggerText}` : `Pump OFF ${triggerText}`;
  }
  if (type === 'mode') {
    return action === 'AUTO' ? 'Mode ‚Üí AUTO' : 'Mode ‚Üí MANUAL';
  }
  return action;
}

function renderHistory() {
  const container = document.getElementById('historyContainer');
  const filter = document.getElementById('historyFilter').value;
  const dateKey = formatDate(historyViewDate);
  
  let dayEvents = eventHistory[dateKey] || [];
  
  // Apply filter
  let filtered = dayEvents;
  if (filter === 'pump') filtered = dayEvents.filter(h => h.type === 'pump');
  else if (filter === 'mode') filtered = dayEvents.filter(h => h.type === 'mode');
  else if (filter === 'auto') filtered = dayEvents.filter(h => h.trigger === 'auto');
  else if (filter === 'manual') filtered = dayEvents.filter(h => h.trigger === 'manual');
  
  document.getElementById('historyCount').innerText = `${filtered.length} events on ${dateKey}`;
  
  if (filtered.length === 0) {
    container.innerHTML = '<div class="no-data">No events on this date</div>';
    updateHistoryStorageInfo();
    return;
  }
  
  container.innerHTML = filtered.slice().reverse().map(h => {
    const icon = getHistoryIcon(h.type, h.action);
    const text = getHistoryText(h.type, h.action, h.trigger);
    const eventClass = h.action.toLowerCase();
    const badgeClass = h.trigger || 'auto';
    const badgeText = h.trigger === 'manual' ? 'MANUAL' : h.trigger === 'system' ? 'SYSTEM' : 'AUTO';
    
    return `
      <div class="history-item">
        <div class="history-icon">${icon}</div>
        <div class="history-main">
          <div class="history-event ${eventClass}">${text}</div>
          <div class="history-details">
            <span class="history-badge ${badgeClass}">${badgeText}</span>
            ${h.type === 'pump' ? ` ‚Ä¢ Soil: ${h.soil}%` : ''}
          </div>
        </div>
        <div class="history-right">
          <div class="history-time">${h.time}</div>
        </div>
      </div>
    `;
  }).join('');
  
  updateHistoryStorageInfo();
}

function updateHistoryStorageInfo() {
  const stats = getStorageStats();
  document.getElementById('historyStorageInfo').innerText = 
    `Storage: ${stats.totalEvents} events across ${stats.eventDays} days (max ${MAX_DAYS} days)`;
}

function addEvent(type, action, trigger, soil) {
  console.log(">>> addEvent:", type, action, trigger, soil);
  
  const now = new Date();
  const dateKey = getDateKey(now);
  const time = formatTime(now);
  
  if (!eventHistory[dateKey]) {
    eventHistory[dateKey] = [];
  }
  
  eventHistory[dateKey].push({ type, action, trigger, soil, time });
  
  // Limit per day
  if (eventHistory[dateKey].length > 500) {
    eventHistory[dateKey].shift();
  }
  
  saveData();
  
  // Update if viewing today
  if (formatDate(historyViewDate) === dateKey) {
    renderHistory();
  }
}

document.getElementById('historyFilter').addEventListener('change', renderHistory);

document.getElementById('clearHistory').addEventListener('click', () => {
  if (confirm('Clear ALL history data (all dates)?')) {
    eventHistory = {};
    localStorage.removeItem('eventHistory_v' + DATA_VERSION);
    renderHistory();
  }
});

document.getElementById('clearTrends').addEventListener('click', () => {
  if (confirm('Clear ALL trend data (all dates)?')) {
    trendData = {};
    localStorage.removeItem('trendData_v' + DATA_VERSION);
    updateCharts();
  }
});

// ============ MQTT ============
const mqttHost = "a83ccc7ca89145d195e89865c270d0f2.s1.eu.hivemq.cloud";
const mqttUser = "Soil_System";
const mqttPass = "Soilsystem123";
const clientId = "web_" + Math.random().toString(16).substr(2, 8);

const client = mqtt.connect(`wss://${mqttHost}:8884/mqtt`, {
  clientId, username: mqttUser, password: mqttPass, reconnectPeriod: 3000
});

function updateConnectionStatus(connected) {
  document.getElementById('statusDot').classList.toggle('online', connected);
  document.getElementById('statusText').innerText = connected ? 'Connected to MQTT' : 'Disconnected - Reconnecting...';
}

function updateManualControls() {
  document.getElementById('manualControls').classList.toggle('show', currentMode === "MANUAL");
}

client.on("connect", () => {
  console.log("MQTT Connected");
  updateConnectionStatus(true);
  
  client.subscribe("soil_system/data", (err) => {
    if (err) console.error("Subscribe data error:", err);
    else console.log("Subscribed to soil_system/data");
  });
  
  client.subscribe("soil_system/event", (err) => {
    if (err) console.error("Subscribe event error:", err);
    else console.log("Subscribed to soil_system/event");
  });
  
  setTimeout(() => {
    client.publish("soil_system/get_data", "1");
  }, 500);
});

client.on("disconnect", () => updateConnectionStatus(false));
client.on("error", () => updateConnectionStatus(false));

client.on("message", (topic, message) => {
  const msg = message.toString();
  
  if (topic === "soil_system/data") {
    try {
      const d = JSON.parse(msg);
      document.getElementById('soilPercent').innerText = d.soilPercent + ' %';
      document.getElementById('soilRaw').innerText = d.soilRaw;
      document.getElementById('tempVal').innerText = d.temp > -90 ? d.temp.toFixed(1) + '¬∞C' : '--¬∞C';
      document.getElementById('humVal').innerText = d.hum >= 0 ? d.hum.toFixed(1) + '%' : '--%';
      
      const pumpEl = document.getElementById('pumpState');
      const isOn = d.pump === 1;
      pumpEl.innerText = isOn ? 'ON' : 'OFF';
      pumpEl.classList.toggle('on', isOn);
      
      currentMode = d.mode;
      document.getElementById('modeSelect').value = d.mode;
      updateManualControls();
      
      if (!userEditingSetpoint) document.getElementById('setpoint').value = d.setpoint;
      if (!userEditingHysteresis) document.getElementById('hysteresis').value = d.hysteresis || 5;
      
      const low = d.lowThreshold || (d.setpoint - (d.hysteresis || 5));
      document.getElementById('thresholdInfo').innerText = `Pump ON < ${low}% | OFF ‚â• ${d.setpoint}%`;
      
      addTrendPoint(d.soilPercent, d.temp, d.hum);
    } catch (e) { console.error("Data parse error:", e); }
  }
  
  if (topic === "soil_system/event") {
    console.log(">>> EVENT RECEIVED:", msg);
    try {
      const d = JSON.parse(msg);
      addEvent(d.type, d.action, d.trigger, d.soil);
    } catch (e) { console.error("Event parse error:", e); }
  }
});

// ============ INPUT HANDLERS ============
const setpointInput = document.getElementById('setpoint');
const hysteresisInput = document.getElementById('hysteresis');

setpointInput.addEventListener('focus', () => userEditingSetpoint = true);
setpointInput.addEventListener('blur', () => setTimeout(() => userEditingSetpoint = false, 500));
setpointInput.addEventListener('input', () => userEditingSetpoint = true);

hysteresisInput.addEventListener('focus', () => userEditingHysteresis = true);
hysteresisInput.addEventListener('blur', () => setTimeout(() => userEditingHysteresis = false, 500));
hysteresisInput.addEventListener('input', () => userEditingHysteresis = true);

document.getElementById('setBtn').addEventListener('click', () => {
  let sp = parseInt(setpointInput.value) || 40;
  let hy = parseInt(hysteresisInput.value) || 5;
  sp = Math.max(0, Math.min(100, sp));
  hy = Math.max(1, Math.min(20, hy));
  userEditingSetpoint = false;
  userEditingHysteresis = false;
  client.publish("soil_system/setpoint", JSON.stringify({ setpoint: sp }));
  client.publish("soil_system/hysteresis", JSON.stringify({ hysteresis: hy }));
});

document.getElementById('modeSelect').addEventListener('change', function() {
  currentMode = this.value;
  updateManualControls();
  client.publish("soil_system/setmode", JSON.stringify({ mode: this.value }));
});

document.getElementById('pumpOn').addEventListener('click', () => {
  if (currentMode === "MANUAL") client.publish("soil_system/manualpump", JSON.stringify({ state: 1 }));
});

document.getElementById('pumpOff').addEventListener('click', () => {
  if (currentMode === "MANUAL") client.publish("soil_system/manualpump", JSON.stringify({ state: 0 }));
});

// ============ INIT ============
loadData();
cleanOldData();
renderHistory();
updateCharts();
</script>
</body>
</html>
